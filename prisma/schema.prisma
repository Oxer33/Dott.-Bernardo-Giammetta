// =============================================================================
// PRISMA SCHEMA - DOTT. BERNARDO GIAMMETTA
// Database schema per gestione utenti, appuntamenti, whitelist e email
// Configurato per PostgreSQL su AWS RDS Aurora
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// MODELLO UTENTE
// Gestisce autenticazione Google e dati utente
// =============================================================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  phone         String?
  
  // Password hash per autenticazione email/password (opzionale se usa solo OAuth)
  password      String?
  
  // ==========================================================================
  // DATI ANAGRAFICI COMPLETI (per fatturazione e gestione pazienti)
  // ==========================================================================
  firstName       String?   // Nome
  lastName        String?   // Cognome
  birthDate       DateTime? // Data di nascita
  birthPlace      String?   // Comune di nascita
  birthProvince   String?   // Provincia di nascita (sigla, es: RM)
  gender          String?   // Sesso: "M" | "F"
  codiceFiscale   String?   // Codice fiscale (calcolato o inserito)
  
  // Email di contatto (può essere diversa da email login)
  contactEmail    String?   // Email per comunicazioni e materiali percorso
  
  // Dati di residenza
  address         String?   // Indirizzo (via/piazza + nome)
  addressNumber   String?   // Numero civico
  city            String?   // Comune di residenza
  province        String?   // Provincia di residenza (sigla)
  cap             String?   // CAP
  
  // Stato whitelist - solo utenti in whitelist possono prenotare
  isWhitelisted Boolean   @default(false)
  whitelistedAt DateTime?
  
  // Contatore blacklist - quante volte è stato in blacklist (per recidivi)
  blacklistCount Int      @default(0)
  
  // Punto 5: Stato paziente: "ACTIVE" | "COMPLETED" (Ultimato = completato percorso)
  // I pazienti "COMPLETED" non vengono rimossi dalla whitelist dopo 12 mesi
  patientStatus String    @default("ACTIVE")
  
  // Ruolo utente: "ADMIN" | "PATIENT"
  role          String    @default("PATIENT")
  
  // Relazioni
  appointments    Appointment[]
  emailLogs       EmailLog[]
  invoices        Invoice[]       // Fatture emesse al paziente
  questionnaires  Questionnaire[] // Questionari prima visita
  
  // NextAuth fields
  emailVerified DateTime?
  accounts      Account[]
  sessions      Session[]
  
  // Token verifica email (per registrazione con password)
  verificationToken   String?   @unique
  verificationExpires DateTime?
  
  // Numero massimo prenotazioni attive (default 1 per whitelistati)
  maxActiveBookings   Int       @default(1)
  
  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Data ultima visita per tracking reminder
  lastVisitAt   DateTime?
}

// Role values: "ADMIN" (Dottore), "PATIENT" (Paziente)

// =============================================================================
// MODELLI NEXTAUTH
// Per autenticazione OAuth
// =============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
}

// =============================================================================
// MODELLO APPUNTAMENTO
// Gestisce prenotazioni visite con fasce orarie da 30 min
// =============================================================================

model Appointment {
  id          String            @id @default(cuid())
  
  // Riferimento utente (paziente)
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Data e ora inizio
  startTime   DateTime
  
  // Durata in minuti (60 per visite normali, 90 per prima visita)
  duration    Int               @default(60)
  
  // Tipo di appuntamento: "FIRST_VISIT" | "FOLLOW_UP"
  type        String            @default("FOLLOW_UP")
  
  // Stato appuntamento: "CONFIRMED" | "CANCELLED" | "COMPLETED" | "NO_SHOW"
  status      String            @default("CONFIRMED")
  
  // Note (visibili solo al dottore)
  notes       String?
  
  // Timestamps
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  cancelledAt DateTime?
  
  @@index([startTime])
  @@index([userId])
  @@index([status])
}

// AppointmentType values: "FIRST_VISIT" (90 min), "FOLLOW_UP" (60 min)
// AppointmentStatus values: "CONFIRMED", "CANCELLED", "COMPLETED", "NO_SHOW"

// =============================================================================
// MODELLO BLOCCO ORARIO
// Per impegni ricorrenti settimanali e occasionali del dottore
// =============================================================================

model TimeBlock {
  id          String        @id @default(cuid())
  
  // Tipo di blocco: "RECURRING" | "OCCASIONAL"
  type        String
  
  // Per blocchi RICORRENTI: giorno della settimana (0=Dom, 1=Lun, ..., 6=Sab)
  dayOfWeek   Int?
  
  // Ora inizio e fine (formato "HH:MM")
  startTime   String
  endTime     String
  
  // Per blocchi OCCASIONALI: data specifica
  specificDate DateTime?
  
  // Note private (visibili solo al dottore)
  note        String?
  
  // Se attivo
  isActive    Boolean       @default(true)
  
  // Timestamps
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  @@index([type])
  @@index([dayOfWeek])
  @@index([specificDate])
}

// TimeBlockType values: "RECURRING" (settimanale), "OCCASIONAL" (una tantum)

// =============================================================================
// MODELLO LOG EMAIL
// Traccia tutte le email inviate per evitare duplicati e per analytics
// =============================================================================

model EmailLog {
  id          String    @id @default(cuid())
  
  // Destinatario
  userId      String?
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  toEmail     String
  
  // Tipo di email (stringa)
  type        String
  
  // Template usato (per variare i messaggi)
  templateId  Int
  
  // Riferimento appuntamento (se applicabile)
  appointmentId String?
  
  // Stato invio: "SENT" | "FAILED" | "BOUNCED"
  status      String      @default("SENT")
  
  // Contenuto (per debug/log)
  subject     String
  
  // Timestamp
  sentAt      DateTime    @default(now())
  
  @@index([userId])
  @@index([type])
  @@index([sentAt])
}

// EmailType values: "BOOKING_CONFIRMATION", "BOOKING_NOTIFICATION", 
// "CANCELLATION_CONFIRMATION", "CANCELLATION_NOTIFICATION", "REMINDER_1_WEEK",
// "REMINDER_1_DAY", "FOLLOWUP_25_DAYS", "URGENT_60_DAYS", "WELCOME", "WHITELIST_APPROVED"
// EmailStatus values: "SENT", "FAILED", "BOUNCED"

// =============================================================================
// MODELLO ARTICOLO BLOG
// Per gestione contenuti blog
// =============================================================================

model BlogPost {
  id           String   @id @default(cuid())
  slug         String   @unique
  title        String
  excerpt      String
  content      String   // Markdown
  coverImage   String
  category     String
  tags         String   // JSON array serializzato
  readingTime  Int
  published    Boolean  @default(false)
  publishedAt  DateTime?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([slug])
  @@index([published])
  @@index([category])
}

// =============================================================================
// MODELLO CONTATTO
// Per messaggi dal form contatti
// =============================================================================

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  subject   String
  message   String
  read      Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([read])
  @@index([createdAt])
}

// =============================================================================
// MODELLO FATTURA
// Per generazione fatture sanitarie (integrazione software STS)
// =============================================================================

model Invoice {
  id              String    @id @default(cuid())
  
  // Riferimento paziente
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Dati fattura
  invoiceNumber   String    @unique  // Numero fattura (es: "1/2026")
  invoiceYear     Int       // Anno fattura per progressivo
  invoiceDate     DateTime  // Data emissione
  
  // Importi (calcolati dalle righe)
  subtotal        Decimal   @db.Decimal(10, 2)  // Imponibile (somma righe)
  contributo      Decimal   @db.Decimal(10, 2)  // Contributo ENPAB 4%
  bollo           Decimal   @db.Decimal(10, 2)  // Marca da bollo (se > 77.47€)
  total           Decimal   @db.Decimal(10, 2)  // Totale fattura
  
  // Metodo pagamento: MP01=Contanti, MP05=Bonifico, MP08=POS
  paymentMethod   String    @default("MP05")
  
  // Stato: EMESSA, PAGATA, ANNULLATA
  status          String    @default("EMESSA")
  
  // Descrizione prestazione principale (per modifica rapida)
  description     String?   // Es: "Prima visita nutrizionale"
  
  pdfPath         String?   // Path al file PDF generato
  stsSubmitted    Boolean   @default(false)    // Inviata a Sistema Tessera Sanitaria
  stsSubmittedAt  DateTime?
  
  // Righe fattura (prestazioni)
  items           InvoiceItem[]
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([userId])
  @@index([invoiceNumber])
  @@index([invoiceYear])
  @@index([status])
  @@index([invoiceDate])
}

// =============================================================================
// MODELLO RIGA FATTURA
// Singola prestazione in una fattura
// =============================================================================

model InvoiceItem {
  id            String    @id @default(cuid())
  
  // Riferimento fattura
  invoiceId     String
  invoice       Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  // Descrizione prestazione
  description   String
  
  // Importo (senza contributo)
  amount        Decimal   @db.Decimal(10, 2)
  
  // Ordine di visualizzazione
  order         Int       @default(0)
  
  @@index([invoiceId])
}

// =============================================================================
// MODELLO NATURA SPESA (PRESTAZIONI SALVATE)
// Per riutilizzare prestazioni comuni
// =============================================================================

model ExpenseType {
  id            String    @id @default(cuid())
  description   String    // Es: "Prima visita nutrizionale"
  defaultAmount Decimal   @db.Decimal(10, 2)  // Importo predefinito
  isActive      Boolean   @default(true)
  order         Int       @default(0)  // Ordine di visualizzazione
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([isActive])
}

// =============================================================================
// MODELLO COMUNI ITALIANI
// Per calcolo automatico codice fiscale
// =============================================================================

model Comune {
  id              String   @id @default(cuid())
  nome            String   // Nome comune
  provincia       String   // Sigla provincia (es: RM)
  regione         String   // Nome regione
  codiceCatastale String   @unique  // Codice catastale per CF (es: H501 = Roma)
  cap             String?  // CAP principale
  
  @@index([nome])
  @@index([provincia])
}

// =============================================================================
// MODELLO QUESTIONARIO PRIMA VISITA
// Questionario obbligatorio da compilare prima della prima visita
// I questionari NON sono modificabili, si può solo crearne uno nuovo
// =============================================================================

model Questionnaire {
  id              String    @id @default(cuid())
  
  // Riferimento paziente
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Stile alimentare: "ONNIVORO" | "VEGETARIANO" | "VEGANO"
  // Determina quali domande vengono mostrate (19-44, 45-65, 66-84)
  dietType        String
  
  // Risposte alle domande comuni (1-17) - JSON serializzato
  // Struttura: { "q5": "risposta", "q6": "risposta", ... }
  commonAnswers   String    @db.Text
  
  // Risposte alle domande specifiche per stile alimentare - JSON serializzato
  // ONNIVORO: q19-q44, VEGETARIANO: q45-q65, VEGANO: q66-q84
  dietAnswers     String    @db.Text
  
  // Dati fatturazione (domanda finale comune a tutti)
  // Struttura: { birthPlace, address, addressNumber, cap, city, codiceFiscale }
  billingData     String    @db.Text
  
  // Autorizzazione privacy (checkbox finale obbligatoria)
  privacyConsent  Boolean   @default(false)
  
  // Flag per indicare se è stato inviato reminder email
  reminderSent    Boolean   @default(false)
  reminderSentAt  DateTime?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  
  // NON c'è updatedAt perché i questionari NON sono modificabili
  
  @@index([userId])
  @@index([createdAt])
}
